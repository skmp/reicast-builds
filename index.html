<html>
	<head>
		<title>Reicast CI Builds</title>
		<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
		<style>
			.hide-element {
				display: none;
			}

			#header, #builds td.commit, #builds td.date {
				font-family:"Courier New", Courier, monospace;
			}

			body {
				font:13px Helvetica,  Arial,  sans-serif;
			}

			html, body, div {
				margin:0;
				padding:0;
				border:0;
			}

			.wrap {
				margin:0 auto;
				width:630px;
			}

			#header, #footer {
				float:left;
				padding:15px 0;
				min-width:100%;
			}

			#header {
				color:fff;
				background: #131313; /* Old browsers */
				background: -moz-linear-gradient(top,  #131313 0%, #333333 94%, #000000 96%, #ffffff 100%); /* FF3.6+ */
				background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#131313), color-stop(94%,#333333), color-stop(96%,#000000), color-stop(100%,#ffffff)); /* Chrome,Safari4+ */
				background: -webkit-linear-gradient(top,  #131313 0%,#333333 94%,#000000 96%,#ffffff 100%); /* Chrome10+,Safari5.1+ */
				background: -o-linear-gradient(top,  #131313 0%,#333333 94%,#000000 96%,#ffffff 100%); /* Opera 11.10+ */
				background: -ms-linear-gradient(top,  #131313 0%,#333333 94%,#000000 96%,#ffffff 100%); /* IE10+ */
				background: linear-gradient(to bottom,  #131313 0%,#333333 94%,#000000 96%,#ffffff 100%); /* W3C */
				filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#131313', endColorstr='#ffffff',GradientType=0 ); /* IE6-9 */
			}

			#header .logo {
				float:left;
				width:60px;
			}

			#header h1 {
				width:570px;
				margin:0;
				padding:0;
				line-height: 48px;
				font-size: x-large;
				font-weight: normal;
				text-transform: lowercase;
			}

			#content {
				padding:15px 0;
				clear:both;
			}

			#builds table {
				width:100%;
				font-size: small;
			}

			#builds tr.even
			{
				background-color:#efefef;
			}

			#builds td {
				vertical-align: top;
				padding:0 10px 0 0;
			}

			#builds td.date, #builds td.commit {
					white-space: nowrap;
					width:1%;
			}
			#builds th {
				text-align: left;
			}

			#builds th.branch
			{
				font-size: large;
			}
		</style>
		<script type="text/javascript">
			$( document ).ready(function() {
				function keys(obj)
				{
						var keys = [];
						for(var key in obj)
						{
								if(obj.hasOwnProperty(key))
								{
										keys.push(key);
								}
						}
						return keys;
				}

				function format_size(bytes) {
					var i = 0;
					var units = ['B', 'kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
					while(bytes > 1000)
					{
							bytes = bytes/1000;
							i++;
					} 
					return Math.max(bytes, 0.1).toFixed(1) + ' ' + units[i];
				};

				$('#builds').removeClass("hide-element");

				var unknown_branch = "[others]"
				var master_branch = "master"
				var builds = new Array();
				var branches = [];

				function add_build(branch, commit, platform, last_modified, build)
				{
					if(!builds.hasOwnProperty(branch))
					{
						builds[branch] = new Array();
						branches.push(branch);
					}
					if(!builds[branch].hasOwnProperty(commit))
					{
						builds[branch][commit] = {
							last_modified: last_modified,
							platforms: {
								android: null,
								win_x86: null,
								win_x64: null
							}
						}
					}
					builds[branch][commit].platforms[platform] = build;
					if(builds[branch][commit].last_modified > last_modified)
					{
						builds[branch][commit].last_modified = last_modified;
					}
				}

				function print_builds(element)
				{
					// Create a sorted list of branches
					branches.sort();
					var pos = branches.indexOf(master_branch)
					if (pos > 0)
					{
						branches.splice(pos, 1);
						branches.unshift(master_branch);
					}
					pos = branches.indexOf(unknown_branch)
					if (pos >= 0)
					{
						branches.splice(pos, 1);
						branches.push(unknown_branch);
					}

					var el_table = $('<table></table>');

					// Loop over braches
					for(i = 0; i < branches.length; i++)
					{
						var branch_name = branches[i];
						var branch = builds[branch_name];
						console.log(branch_name);
						el_table.append('<tr><th colspan="3" class="branch" id="' + branch_name +  '">' + branch_name + '</th></tr>');
						el_table.append('<tr><th>Commit</th><th>Date</th><th><img src="http://i.imgur.com/nK9exQe.jpg" /> Android</th><th><img src="http://i.imgur.com/hAuMmjF.png" /> Win_x86</th><th><img src="http://i.imgur.com/hAuMmjF.png" /> Win_x64</th></tr>');

						// Create a sorted list of commit ids
						var commit_ids = keys(branch).sort(function(a, b)
						{
							var date_a = branch[a].last_modified;
							var date_b = branch[b].last_modified
							return ((date_a > date_b) ? -1 : ((date_a < date_b) ? 1 : 0));
						});

						for(var j = 0; j < commit_ids.length; j++)
						{
							var s_trclass = ((j % 2) == 0) ? ' class="even"' : '';
							var commit_id = commit_ids[j];
							var commit = branch[commit_id];
							console.log(commit);
							var s_date = commit.last_modified.toISOString();
							var s_commit = '<a href="https://github.com/reicast/reicast-emulator/commit/' + commit_id + '">'+ commit_id +'</a>';
							s_android = (commit.platforms.android == null) ? '' : '<a href="http://reicast-builds.s3.amazonaws.com/' + commit.platforms.android.path + '">APK</a> (' + format_size(commit.platforms.android.filesize) + ')';
							s_win86 = (commit.platforms.win_x86 == null) ? '' : '<a href="http://reicast-builds-windows.s3.amazonaws.com/' + commit.platforms.win_x86.path + '">ZIP</a> (' + format_size(commit.platforms.win_x86.filesize) + ')';
							s_win64 = (commit.platforms.win_x64 == null) ? '' : '<a href="http://reicast-builds-windows.s3.amazonaws.com/' + commit.platforms.win_x64.path + '">ZIP</a> (' + format_size(commit.platforms.win_x64.filesize) + ')';
							el_table.append('<tr'+s_trclass+'><td class="commit">' + s_commit  + '</td><td class="date">' + commit.last_modified.toISOString() + '</td><td>' + s_android + '</td><td>' + s_win86 + '</td><td>' + s_win64 + '</td></tr>');
						}
					}

					$(element).empty();
					$(element).append(el_table);
				}

				$.when(
					// Get the Android builds
					$.get("https://reicast-builds.s3.amazonaws.com/"),

					// Get the Windows builds
					$.get("https://reicast-builds-windows.s3.amazonaws.com/")
				).then(function(xml_android, xml_windows)
				{
					// Parse the Android builds
					contents = xml_android[2].responseXML.getElementsByTagName('Contents');
					for(i = 0; i < contents.length; i++)
					{
						var path = contents[i].getElementsByTagName('Key')[0].firstChild.data;
						var branch = path.indexOf("builds/heads") == 0 && path.replace(/^builds\/heads\//,"").replace(/\/[^\/]*$/,"").replace(/\-[^\-]*$/,"") || unknown_branch;
						var name = path.substring(path.lastIndexOf("/") + 1);
						var commit = name.substring(name.lastIndexOf("-")+1, name.lastIndexOf(".")).substring(0, 7);
						var filesize = contents[i].getElementsByTagName('Size')[0].firstChild.data;
						var last_modified = new Date(contents[i].getElementsByTagName('LastModified')[0].firstChild.data);
						add_build(branch, commit, "android", last_modified, {
							name: name,
							path: path,
							filesize: filesize,
							last_modified: last_modified
						});
					}

					// Parse the Windows builds
					contents = xml_windows[2].responseXML.getElementsByTagName('Contents');
					for(i = 0; i < contents.length; i++)
					{
						var path = contents[i].getElementsByTagName('Key')[0].firstChild.data;
						var branch = path.indexOf("builds/heads") == 0 && path.replace(/^builds\/heads\//,"").replace(/\/[^\/]*$/,"").replace(/\-[^\-]*$/,"") || unknown_branch;
						var name = path.substring(path.lastIndexOf("/") + 1);
						var commit = name.substring(name.lastIndexOf("-") + 1, name.lastIndexOf(".")).substring(0, 7);
						var last_modified = new Date(contents[i].getElementsByTagName('LastModified')[0].firstChild.data);
						var filesize = contents[i].getElementsByTagName('Size')[0].firstChild.data;
						var platform = name.substring(name.indexOf("-") + 1, name.indexOf("-") + 8)
						add_build(branch, commit, platform, last_modified, {
							name: name,
							path: path,
							filesize: filesize,
							last_modified: last_modified
						});
					}

					print_builds("#builds");
				});
			});
		</script>
		<script type="text/javascript">
			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

			ga('create', 'UA-46560202-4', 'auto');
			ga('require', 'displayfeatures');
			ga('send', 'pageview');
			ga('send', 'event', 'page', 'loaded', null, null, true);

			$('body').on('click', 'a[data-action]', function() {
				ga('send', 'event', 'build', $(this).attr('data-action'), $(this).attr('data-build'));
			});
		</script>
	</head>
	<body class="no-js">
		<div id="header">
			<div class="wrap">
				<div class="logo">
						<a href="#"><img src="https://raw.githubusercontent.com/reicast/reicast-emulator/master/shell/android/res/drawable-mdpi/ic_launcher.png	"></a>
				</div>
				<h1>Reicast CI Builds</h1>
			</div>
		</div>
		<div class="wrap">
			<div id="content">
				<p><strong>Warning:</strong> These are bleeding-edge development builds, that are used for testing and debugging purposes. They might be unstable (or might even crash or refuse to run at all), have bad performance (since they usually have debugging symbols compiled in) and are not made for every-day usage. If you just want to play, head over to the <a href="http://reicast.com/downloads">official Downloads page</a> and download the stable versions there.</p>
				<noscript>This page requires javascript to fetch the data from amazon S3.</noscript>
				<div id="builds" class="hide-element">
					<p>Fetching list ...</p>
				</div>
			</div>
		</div>
	</body>
</html>
